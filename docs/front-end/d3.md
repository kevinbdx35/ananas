---
sidebar_position: 8
---

# La librairie D3

## Visusalisation des données avec la librairie D3

* [**D3.js**](https://d3js.org)

D3, ou D3.js, signifie **Data Driven Documents**, c'est une librairie Javascript permettant de créer des visualisation de données dynamiques et interactives dans ton navigateur.
Elle est très populaire, robuste et avec de nombreuses fonctionnalités. Apprendre à l'utiliser sera un réel plus sur ton cv.

D3 est conçu pour fonctionner avec les normes Web courantes, à savoir HTML, CSS et Scalable Vector Graphics (SVG).

D3 prend en charge de nombreux types de formats de données d'entrée. Ensuite, à l'aide de ses puissantes méthodes intégrées, tu peux transformer ces données en différents tableaux, graphiques et cartes.

La visualisation des données est une représentation graphique et logique de données afin que ces dernières puissent être mise en valeur et les rendre plus parlantes qu'uniquement des chiffres qui sont plus difficiles à interprêter quand la quantité est énorme.

* [Exemple de visualisation de données avec D3.js](http://www.brandlovescore.com/blackfriday2017/#bf)

## Installation

Il existe plusieurs manière de mettre en oeuvre cette librairie. Ici, tu vas utiliser le CDN. Si tu souhaites utiliser une autre mnanière tu peux aller lire la documentation [**Installation**](https://github.com/d3/d3/blob/main/README.md#installing)

```html {9,11}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D3.js Project</title>

    <script src="https://cdn.jsdelivr.net/npm/d3@7" defer></script>

    <script src="main.js" defer></script>

</head>
<body>
    <div class = "box"></div>
</body>
</html>
```

Tu implémentes les balises scripts pour appeler le `CDN` et la page de ton code javascript `main.js` dans le `head` de ton HTML en ajoutant l'attribut `defer` qui permet d'indiquer au navigateur de ne pas attendre le script pour charger le reste du DOM.

C'est la meilleure manière et la plus rapide de faire appelle à du script.

Tu as aussi mis une `div` avec une `class`.

## Select et SelectAll

D3 dispose de plusieurs méthodes qui te permettent d'ajouter et de modifier des éléments dans ton document.

La méthode `select()` sélectionne un élément du document. Il prend un argument pour le nom de l'élément souhaité et renvoie un nœud HTML pour le premier élément du document qui correspond au nom.

Tu vas maintenant essentiellement travailler dans ta page javascript `main.js`.
 

```js title="ici, tu selectionnes uniquement l'élément ayant la class .box"
const box = d3.select(`.box`);
```

```js title="ici, tu selectionnes tous les éléments div"
const div = d3.selectAll("div");
```

## Append

La méthode `append()` prend un argument pour l'élément que vous souhaitez ajouter au document. Il ajoute un nœud HTML à un élément sélectionné et renvoie un descripteur à ce nœud.

`append` te permet d'ajouter des éléments. Ici, tu déclares trois éléments, un rectangle, une ligne et un cercle.

```js {5-7}
const box = d3.select(`.box`);

const svg = box.append('svg');

svg.append('rect');
svg.append('line');
svg.append('circle');
```

## La méthode attr

C'est la méthode attribut `attr`, qui permet d'ajouter des attributs par exemple à tes svg.

```js {5-6} title="Tu crées en ajout les attributs height et width ton envinonnement de travail"
const box = d3.select(`.box`);

const svg = box.append('svg');

svg.attr('height', 500);
svg.attr('width', 500);

svg.append('rect');
svg.append('line');
svg.append('circle');
```

### Enchaîner les méthodes

Pour gagner de la place et des lignes, tu peux enchaîner les méthodes comme dans l'exemple suivant.

```js {3}
const box = d3.select(`.box`);

const svg = box.append('svg').attr('height', 500).attr('width', 500);

svg.append('rect');
svg.append('line');
svg.append('circle');
```

Une meilleure manière d'écrire la même chose pour que ça soit plus lisible.

```js {3-5}
const box = d3.select(`.box`);

const svg = box.append('svg')
    .attr('height', 500)
    .attr('width', 500);

svg.append('rect');
svg.append('line');
svg.append('circle');
```

Maintenant, tu vas ajouter des attributs à tes éléments svg.

```js {7-12,14-19,21-25}
const box = d3.select(`.box`);

const svg = box.append('svg')
    .attr('height', 500)
    .attr('width', 500);

svg.append('rect')
    .attr('height', 75)
    .attr('width', 100)
    .attr('fill', 'blue')
    .attr('x', 100)
    .attr('y', 100);

svg.append('line');
    .attr('x1', 50)
    .attr('y1', 200)
    .attr('x2', 150)
    .attr('y2', 250)
    .attr('stroke', 'green');

svg.append('circle');
    .attr('r', 75)
    .attr('cx', 100)
    .attr('cy', 150)
    .attr('fill', 'orange');
```

## La méthode text

La méthode text() définit le texte du nœud sélectionné ou obtient le texte actuel. Pour définir la valeur, tu passes une chaîne comme argument entre les parenthèses de la méthode.

```js
d3.select("ul")
  .append("li")
  .text("Very important item");
```

## Les groupes de SVG

Tu vas voir qu'il est intéressant de faire des groupes de svg.

```js {7,9,16,23}
const box = d3.select(`.box`);

const svg = box.append('svg')
    .attr('height', 500)
    .attr('width', 500);

const groupe = svg.append('g');    

groupe.append('rect')
    .attr('height', 75)
    .attr('width', 100)
    .attr('fill', 'blue')
    .attr('x', 100)
    .attr('y', 100);

groupe.append('line');
    .attr('x1', 50)
    .attr('y1', 200)
    .attr('x2', 150)
    .attr('y2', 250)
    .attr('stroke', 'green');

groupe.append('circle');
    .attr('r', 75)
    .attr('cx', 100)
    .attr('cy', 150)
    .attr('fill', 'orange');
```

C'est très pratique, car tu peux ainsi ajouter des attributs à l'ensemble des formes dessinées en `svg` en les ajoutant directement au groupe.
Dans l'exemple suivant, tu vas déplacer ainsi tous tes éléments en une ligne.

```js {8}
const box = d3.select(`.box`);

const svg = box.append('svg')
    .attr('height', 500)
    .attr('width', 500);

const groupe = svg.append('g')
    .attr('transform', 'translate(0, 100');

groupe.append('rect')
    .attr('height', 75)
    .attr('width', 100)
    .attr('fill', 'blue')
    .attr('x', 100)
    .attr('y', 100);

groupe.append('line');
    .attr('x1', 50)
    .attr('y1', 200)
    .attr('x2', 150)
    .attr('y2', 250)
    .attr('stroke', 'green');

groupe.append('circle');
    .attr('r', 75)
    .attr('cx', 100)
    .attr('cy', 150)
    .attr('fill', 'orange');
```

## Manipulation de nos premières données

La bibliothèque D3 se concentre sur une approche axée sur les données. Lorsque tu disposes d'un ensemble de données, tu peux appliquer des méthodes D3 pour l'afficher sur la page. Les données se présentent sous de nombreux formats.

La première étape consiste à informer D3 des données. La méthode `data()` est utilisée sur une sélection d'éléments DOM pour attacher les données à ces éléments. L'ensemble de données est passé en argument à la méthode.

Un modèle de workflow courant consiste à créer un nouvel élément dans le document pour chaque donnée de l'ensemble. D3 a la méthode `enter()` à cet effet.

Lorsque `enter()` est combiné avec la méthode `data()`, il examine les éléments sélectionnés de la page et les compare au nombre d'éléments de données dans l'ensemble. S'il y a moins d'éléments que d'éléments de données, il crée les éléments manquants.

Voici un exemple qui sélectionne un élément ul et crée un nouvel élément de liste en fonction du nombre d'entrées dans le tableau :

```html
<body>
  <ul></ul>
  <script>
    const dataset = ["a", "b", "c"];
    d3.select("ul").selectAll("li")
      .data(dataset)
      .enter()
      .append("li")
      .text("New item");
  </script>
</body>
```

Il peut sembler déroutant de sélectionner des éléments qui n'existent pas encore. Ce code indique à D3 de sélectionner d'abord l'ul sur la page. Ensuite, sélectionnez tous les éléments de la liste, ce qui renvoie une sélection vide. Ensuite, la méthode `data()` examine l'ensemble de données et exécute le code suivant trois fois, une fois pour chaque élément du tableau. La méthode `enter()` voit qu'il n'y a pas d'éléments li sur la page, mais il en faut 3 (un pour chaque élément de données dans l'ensemble de données). Les nouveaux éléments `li` sont ajoutés à l'`ul` et ont le texte `New item`.

```js
const dataset = [12, 31, 22, 17, 25, 18, 29, 14, 9];

    d3.select("body").selectAll("h2")
      .data(dataset)
      .enter()
      .append("h2")
      
      .text((dataset) => dataset + " USD");

```

## Ajouter un style en ligne aux éléments

D3 te permet d'ajouter des styles CSS en ligne sur des éléments dynamiques avec la méthode `style()`.

La méthode `style()` prend une paire clé-valeur séparée par des virgules comme argument. Voici un exemple pour définir la couleur du texte de la sélection sur bleu :

```js
selection.style("couleur","bleu");
```

## Modifier les styles en fonction des données

D3 concerne la visualisation et la présentation des données. Il est probable que tu souhaities modifier le style des éléments en fonction des données. tu peux utiliser une fonction de rappel dans la méthode `style()` pour modifier le style de différents éléments.

Tu peux souhaiter colorer un point de données en bleu s'il a une valeur inférieure à 20, et en rouge dans le cas contraire. tu peux utiliser une fonction de rappel dans la méthode `style()` et inclure la logique conditionnelle. La fonction de rappel utilise le paramètre `d` pour représenter le point de données.

```js
selection.style("color", (d) => {

});
```

La méthode `style()` ne se limite pas à définir la couleur - elle peut également être utilisée avec d'autres propriétés CSS.

```js
   const dataset = [12, 31, 22, 17, 25, 18, 29, 14, 9];

    d3.select("body").selectAll("h2")
      .data(dataset)
      .enter()
      .append("h2")
      .text((d) => (d + " USD"))
      // Add your code below this line
      .style("color", (d) => {
        if(d > 20){
          return "green";
        }else{
          return "red";
        }
        });
```

## Ajouter des classes avec D3

L'utilisation de nombreux styles en ligne sur les éléments HTML devient difficile à gérer, même pour les petites applications. Il est plus facile d'ajouter une classe aux éléments et de styler cette classe une fois en utilisant les règles CSS. D3 a la méthode `attr()` pour ajouter n'importe quel attribut HTML à un élément, y compris un nom de classe.

La méthode `attr()` fonctionne de la même manière que `style()`. Il prend des valeurs séparées par des virgules et peut utiliser une fonction de rappel. Voici un exemple pour ajouter une classe de conteneur à une sélection.

```js
selection.attr("class", "container");
```

Notes que le paramètre de classe restera le même chaque fois que tu auras besoin d'ajouter une classe et que seul le paramètre de conteneur changera.

```html {17}
<style>
  .bar {
    width: 25px;
    height: 100px;
    display: inline-block;
    background-color: blue;
  }
</style>
<body>
  <script>
    const dataset = [12, 31, 22, 17, 25, 18, 29, 14, 9];

    d3.select("body").selectAll("div")
      .data(dataset)
      .enter()
      .append("div")
      .attr("class", "bar");

  </script>
</body>
```

## Mettre à jour dynamiquement la hauteur d'un élément

Tu as vu comment afficher les données d'un tableau et comment ajouter des classes CSS. Tu peux combiner ces leçons pour créer un graphique à barres simple. Il y a deux étapes pour cela :

1. Créer une div pour chaque point de données dans le tableau
2. Donnes à chaque div une hauteur dynamique, en utilisant une fonction de rappel dans la méthode `style()` qui définit la hauteur égale à la valeur des données

Rappele, le format pour définir un style à l'aide d'une fonction de rappel :

```js
selection.style("cssProperty", (d) => d)
```
```html {18}
<style>
  .bar {
    width: 25px;
    height: 100px;
    display: inline-block;
    background-color: blue;
  }
</style>
<body>
  <script>
    const dataset = [12, 31, 22, 17, 25, 18, 29, 14, 9];

    d3.select("body").selectAll("div")
      .data(dataset)
      .enter()
      .append("div")
      .attr("class", "bar")
      .style("height", (dataset) => dataset + "px")
  </script>
</body>
```